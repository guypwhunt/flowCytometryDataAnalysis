if (flipFoldChange) {
combinedDf[,"logFC"] <- 0-combinedDf[,"logFC"]
}
# Bonferroni P-Value Adjustment
combinedDf[, "bonferroni_adjusted_p_val"] <- p.adjust(combinedDf[, "p_val"], method = "bonferroni")
combinedDf[, "minus_log_bonferroni_adjusted_p_val"] <- 0-log10(combinedDf[, "bonferroni_adjusted_p_val"])
# Benjamini and Hochberg P-Value Adjustment
combinedDf[, "fdr_adjusted_p_val"] <- p.adjust(combinedDf[, "p_val"], method = "fdr")
combinedDf[, "minus_log_fdr_adjusted_p_val"] <- 0-log10(combinedDf[, "fdr_adjusted_p_val"])
# Update differential expression column
combinedDf$bonferroni_diff_expressed <- "NO"
combinedDf$bonferroni_diff_expressed[combinedDf[,"logFC"] < 0 & combinedDf[,"bonferroni_adjusted_p_val"] < sigCutOff] <- "DOWN"
combinedDf$bonferroni_diff_expressed[combinedDf[,"logFC"] > 0 & combinedDf[,"bonferroni_adjusted_p_val"] < sigCutOff] <- "UP"
combinedDf$fdr_diff_expressed <- "NO"
combinedDf$fdr_diff_expressed[combinedDf[,"logFC"] < 0 & combinedDf[,"fdr_adjusted_p_val"] < sigCutOff] <- "DOWN"
combinedDf$fdr_diff_expressed[combinedDf[,"logFC"] > 0 & combinedDf[,"fdr_adjusted_p_val"] < sigCutOff] <- "UP"
# Update labels
combinedDf[,"fdr_label"] <- combinedDf[,"typeOfCells"]
combinedDf$fdr_label[is.na(combinedDf[,"logFC"])] <- NA
combinedDf$fdr_label[is.na(combinedDf[,"logFC"]) | combinedDf[,"fdr_adjusted_p_val"] > sigCutOff] <- NA
combinedDf[,"bonferroni_label"] <- combinedDf[,"typeOfCells"]
combinedDf$bonferroni_label[is.na(combinedDf[,"logFC"])] <- NA
combinedDf$bonferroni_label[is.na(combinedDf[,"logFC"]) | combinedDf[,"bonferroni_adjusted_p_val"] > sigCutOff] <- NA
# Define Colours
mycolors <- data.frame(DOWN = "blue",
UP = "red",
NO = "black")
setwd("data")
dir.create("pValueAdjustmentsResults", showWarnings = FALSE)
dir.create("figures", showWarnings = FALSE)
figureDirectory <- paste0(getwd(), "/figures/")
if (DA) {
jpeg(file = paste0(
figureDirectory,
"fdr",
str_replace_all(str_replace_all(str_replace_all(fileNames, " ", ""), ",", ""), "\\.", "")[1],
markersOrCell,
".jpeg"
))
par(mar = c(1, 1, 1, 1))
p <- ggplot(data = combinedDf,
aes(
x = logFC,
y = minus_log_fdr_adjusted_p_val,
col = fdr_diff_expressed,
label = fdr_label
)) +
geom_point() +
theme_minimal() +
geom_hline(yintercept = -log10(0.05), col = "red") +
geom_hline(yintercept = -log10(0.01), col = "red") +
scale_colour_manual(values = mycolors) +
geom_text_repel() +
ggtitle("Differential Abundance of Clusters") +
xlab("Log Fold Change") + ylab("0 - Log Adjusted P-Value")
print(p)
dev.off()
gc()
jpeg(file = paste0(
figureDirectory,
"bonferroni",
str_replace_all(str_replace_all(str_replace_all(fileNames, " ", ""), ",", ""), "\\.", "")[1],
markersOrCell,
".jpeg"
))
par(mar = c(1, 1, 1, 1))
p <- ggplot(data = combinedDf,
aes(
x = logFC,
y = minus_log_bonferroni_adjusted_p_val,
col = bonferroni_diff_expressed,
label = bonferroni_label
)) +
geom_point() +
theme_minimal() +
geom_hline(yintercept = -log10(0.05), col = "red") +
geom_hline(yintercept = -log10(0.01), col = "red") +
scale_colour_manual(values = mycolors) +
geom_text_repel() +
ggtitle("Differential Abundance of Clusters") +
xlab("Log Fold Change") + ylab("0 - Log Adjusted P-Value")
print(p)
dev.off()
gc()
} else {
# Update marker columsn
combinedDf[combinedDf[, "marker_id"]=="GPR32...AF488.A","marker_id"] <- "GPR32"
combinedDf[combinedDf[, "marker_id"]=="GPR32.AF488.A","marker_id"] <- "GPR32"
combinedDf[combinedDf[, "marker_id"]=="FPRL1...AF647.A","marker_id"] <- "FPRL1"
combinedDf[combinedDf[, "marker_id"]=="FPRL1.AF647.A","marker_id"] <- "FPRL1"
# fdr figures
jpeg(file = paste0(
figureDirectory,
"gpr32",
"fdr",
str_replace_all(str_replace_all(str_replace_all(fileNames, " ", ""), ",", ""), "\\.", "")[1],
markersOrCell,
".jpeg"
))
par(mar = c(1, 1, 1, 1))
p <- ggplot(data =
combinedDf[combinedDf[, "marker_id"] == "GPR32",],
aes(
x = logFC,
y = minus_log_fdr_adjusted_p_val,
col = fdr_diff_expressed,
label = fdr_label
)) +
geom_point() +
theme_minimal() +
geom_hline(yintercept = -log10(0.05), col = "red") +
geom_hline(yintercept = -log10(0.01), col = "red") +
scale_colour_manual(values = mycolors) +
geom_text_repel() +
ggtitle("Differential States of Clusters") +
xlab("Log Fold Change") + ylab("0 - Log Adjusted P-Value")
print(p)
dev.off()
gc()
jpeg(file = paste0(
figureDirectory,
"fprl1",
"fdr",
str_replace_all(str_replace_all(str_replace_all(fileNames, " ", ""), ",", ""), "\\.", "")[1],
markersOrCell,
".jpeg"
))
par(mar = c(1, 1, 1, 1))
p <- ggplot(data =
combinedDf[combinedDf[, "marker_id"] == "FPRL1",],
aes(
x = logFC,
y = minus_log_fdr_adjusted_p_val,
col = fdr_diff_expressed,
label = fdr_label
)) +
geom_point() +
theme_minimal() +
geom_hline(yintercept = -log10(0.05), col = "red") +
geom_hline(yintercept = -log10(0.01), col = "red") +
scale_colour_manual(values = mycolors) +
geom_text_repel() +
ggtitle("Differential States of Clusters") +
xlab("Log Fold Change") + ylab("0 - Log Adjusted P-Value")
print(p)
dev.off()
# bonferroni figures
jpeg(file = paste0(
figureDirectory,
"gpr32",
"bonferroni",
str_replace_all(str_replace_all(str_replace_all(fileNames, " ", ""), ",", ""), "\\.", "")[1],
markersOrCell,
".jpeg"
))
par(mar = c(1, 1, 1, 1))
p <- ggplot(data =
combinedDf[combinedDf[, "marker_id"] == "GPR32",],
aes(
x = logFC,
y = minus_log_bonferroni_adjusted_p_val,
col = bonferroni_diff_expressed,
label = bonferroni_label
)) +
geom_point() +
theme_minimal() +
geom_hline(yintercept = -log10(0.05), col = "red") +
geom_hline(yintercept = -log10(0.01), col = "red") +
scale_colour_manual(values = mycolors) +
geom_text_repel() +
ggtitle("Differential States of Clusters") +
xlab("Log Fold Change") + ylab("0 - Log Adjusted P-Value")
print(p)
dev.off()
gc()
jpeg(file = paste0(
figureDirectory,
"fprl1",
"bonferroni",
str_replace_all(str_replace_all(str_replace_all(fileNames, " ", ""), ",", ""), "\\.", "")[1],
markersOrCell,
".jpeg"
))
par(mar = c(1, 1, 1, 1))
p <- ggplot(data =
combinedDf[combinedDf[, "marker_id"] == "FPRL1",],
aes(
x = logFC,
y = minus_log_bonferroni_adjusted_p_val,
col = bonferroni_diff_expressed,
label = bonferroni_label
)) +
geom_point() +
theme_minimal() +
geom_hline(yintercept = -log10(0.05), col = "red") +
geom_hline(yintercept = -log10(0.01), col = "red") +
scale_colour_manual(values = mycolors) +
geom_text_repel() +
ggtitle("Differential States of Clusters") +
xlab("Log Fold Change") + ylab("0 - Log Adjusted P-Value")
print(p)
dev.off()
gc()
}
write.csv(combinedDf,
paste0(
"pValueAdjustmentsResults/",
str_replace_all(str_replace_all(
str_replace_all(fileNames, " ", ""), ",", ""
),
"\\.",
"")[1],
markersOrCell,
".csv"
),
row.names = FALSE)
setwd("..")
fileNames <-
c(
paste0(clusterName, "caseControlVisits1SlowAllCellsDifferentialStatesStatistics.csv"),
paste0(clusterName, "caseControlVisits1Slow", markersOrCell, "DifferentialStatesStatistics.csv")
)
for (directory in directories) {
i <- 1
for (file in fileNames) {
names(file) <- names(fileNames)[i]
i <- i +1
filePath <- paste0("data/", directory, "/differentialTestingOutputs/", file)
df <- read.csv(filePath)
df[, "panel"] <- directory
if (names(file) == "allCells") {
if (directory == "bCells") {
df[, "typeOfCells"] <- "B Cells"
} else if (directory == "monocytes") {
df[, "typeOfCells"] <- "Monocytes"
} else if (directory == "tCells") {
df[, "typeOfCells"] <- "T Cells"
} else if (directory == "senescence") {
df[, "typeOfCells"] <- "Senescent T Cells"
}
} else {
df[ , "typeOfCells"] <- df[, "cluster_id"]
}
if (exists("combinedDf")) {
combinedDf <- rbind(combinedDf, df)
} else {
combinedDf <- df
}
}
}
names(fileNames) <- c("allCells", "cellPopulations")
for (directory in directories) {
i <- 1
for (file in fileNames) {
names(file) <- names(fileNames)[i]
i <- i +1
filePath <- paste0("data/", directory, "/differentialTestingOutputs/", file)
df <- read.csv(filePath)
df[, "panel"] <- directory
if (names(file) == "allCells") {
if (directory == "bCells") {
df[, "typeOfCells"] <- "B Cells"
} else if (directory == "monocytes") {
df[, "typeOfCells"] <- "Monocytes"
} else if (directory == "tCells") {
df[, "typeOfCells"] <- "T Cells"
} else if (directory == "senescence") {
df[, "typeOfCells"] <- "Senescent T Cells"
}
} else {
df[ , "typeOfCells"] <- df[, "cluster_id"]
}
if (exists("combinedDf")) {
combinedDf <- rbind(combinedDf, df)
} else {
combinedDf <- df
}
}
}
rm(combinedDf)
for (directory in directories) {
i <- 1
for (file in fileNames) {
names(file) <- names(fileNames)[i]
i <- i +1
filePath <- paste0("data/", directory, "/differentialTestingOutputs/", file)
df <- read.csv(filePath)
df[, "panel"] <- directory
if (names(file) == "allCells") {
if (directory == "bCells") {
df[, "typeOfCells"] <- "B Cells"
} else if (directory == "monocytes") {
df[, "typeOfCells"] <- "Monocytes"
} else if (directory == "tCells") {
df[, "typeOfCells"] <- "T Cells"
} else if (directory == "senescence") {
df[, "typeOfCells"] <- "Senescent T Cells"
}
} else {
df[ , "typeOfCells"] <- df[, "cluster_id"]
}
if (exists("combinedDf")) {
combinedDf <- rbind(combinedDf, df)
} else {
combinedDf <- df
}
}
}
if (flipFoldChange) {
combinedDf[,"logFC"] <- 0-combinedDf[,"logFC"]
}
# Bonferroni P-Value Adjustment
combinedDf[, "bonferroni_adjusted_p_val"] <- p.adjust(combinedDf[, "p_val"], method = "bonferroni")
combinedDf[, "minus_log_bonferroni_adjusted_p_val"] <- 0-log10(combinedDf[, "bonferroni_adjusted_p_val"])
# Benjamini and Hochberg P-Value Adjustment
combinedDf[, "fdr_adjusted_p_val"] <- p.adjust(combinedDf[, "p_val"], method = "fdr")
combinedDf[, "minus_log_fdr_adjusted_p_val"] <- 0-log10(combinedDf[, "fdr_adjusted_p_val"])
# Update differential expression column
combinedDf$bonferroni_diff_expressed <- "NO"
combinedDf$bonferroni_diff_expressed[combinedDf[,"logFC"] < 0 & combinedDf[,"bonferroni_adjusted_p_val"] < sigCutOff] <- "DOWN"
combinedDf$bonferroni_diff_expressed[combinedDf[,"logFC"] > 0 & combinedDf[,"bonferroni_adjusted_p_val"] < sigCutOff] <- "UP"
combinedDf$fdr_diff_expressed <- "NO"
combinedDf$fdr_diff_expressed[combinedDf[,"logFC"] < 0 & combinedDf[,"fdr_adjusted_p_val"] < sigCutOff] <- "DOWN"
combinedDf$fdr_diff_expressed[combinedDf[,"logFC"] > 0 & combinedDf[,"fdr_adjusted_p_val"] < sigCutOff] <- "UP"
# Update labels
combinedDf[,"fdr_label"] <- combinedDf[,"typeOfCells"]
combinedDf$fdr_label[is.na(combinedDf[,"logFC"])] <- NA
combinedDf$fdr_label[is.na(combinedDf[,"logFC"]) | combinedDf[,"fdr_adjusted_p_val"] > sigCutOff] <- NA
combinedDf[,"bonferroni_label"] <- combinedDf[,"typeOfCells"]
combinedDf$bonferroni_label[is.na(combinedDf[,"logFC"])] <- NA
combinedDf$bonferroni_label[is.na(combinedDf[,"logFC"]) | combinedDf[,"bonferroni_adjusted_p_val"] > sigCutOff] <- NA
# Define Colours
mycolors <- data.frame(DOWN = "blue",
UP = "red",
NO = "black")
setwd("data")
dir.create("pValueAdjustmentsResults", showWarnings = FALSE)
dir.create("figures", showWarnings = FALSE)
figureDirectory <- paste0(getwd(), "/figures/")
if (DA) {
jpeg(file = paste0(
figureDirectory,
"fdr",
str_replace_all(str_replace_all(str_replace_all(fileNames, " ", ""), ",", ""), "\\.", "")[1],
markersOrCell,
".jpeg"
))
par(mar = c(1, 1, 1, 1))
p <- ggplot(data = combinedDf,
aes(
x = logFC,
y = minus_log_fdr_adjusted_p_val,
col = fdr_diff_expressed,
label = fdr_label
)) +
geom_point() +
theme_minimal() +
geom_hline(yintercept = -log10(0.05), col = "red") +
geom_hline(yintercept = -log10(0.01), col = "red") +
scale_colour_manual(values = mycolors) +
geom_text_repel() +
ggtitle("Differential Abundance of Clusters") +
xlab("Log Fold Change") + ylab("0 - Log Adjusted P-Value")
print(p)
dev.off()
gc()
jpeg(file = paste0(
figureDirectory,
"bonferroni",
str_replace_all(str_replace_all(str_replace_all(fileNames, " ", ""), ",", ""), "\\.", "")[1],
markersOrCell,
".jpeg"
))
par(mar = c(1, 1, 1, 1))
p <- ggplot(data = combinedDf,
aes(
x = logFC,
y = minus_log_bonferroni_adjusted_p_val,
col = bonferroni_diff_expressed,
label = bonferroni_label
)) +
geom_point() +
theme_minimal() +
geom_hline(yintercept = -log10(0.05), col = "red") +
geom_hline(yintercept = -log10(0.01), col = "red") +
scale_colour_manual(values = mycolors) +
geom_text_repel() +
ggtitle("Differential Abundance of Clusters") +
xlab("Log Fold Change") + ylab("0 - Log Adjusted P-Value")
print(p)
dev.off()
gc()
} else {
# Update marker columsn
combinedDf[combinedDf[, "marker_id"]=="GPR32...AF488.A","marker_id"] <- "GPR32"
combinedDf[combinedDf[, "marker_id"]=="GPR32.AF488.A","marker_id"] <- "GPR32"
combinedDf[combinedDf[, "marker_id"]=="FPRL1...AF647.A","marker_id"] <- "FPRL1"
combinedDf[combinedDf[, "marker_id"]=="FPRL1.AF647.A","marker_id"] <- "FPRL1"
# fdr figures
jpeg(file = paste0(
figureDirectory,
"gpr32",
"fdr",
str_replace_all(str_replace_all(str_replace_all(fileNames, " ", ""), ",", ""), "\\.", "")[1],
markersOrCell,
".jpeg"
))
par(mar = c(1, 1, 1, 1))
p <- ggplot(data =
combinedDf[combinedDf[, "marker_id"] == "GPR32",],
aes(
x = logFC,
y = minus_log_fdr_adjusted_p_val,
col = fdr_diff_expressed,
label = fdr_label
)) +
geom_point() +
theme_minimal() +
geom_hline(yintercept = -log10(0.05), col = "red") +
geom_hline(yintercept = -log10(0.01), col = "red") +
scale_colour_manual(values = mycolors) +
geom_text_repel() +
ggtitle("Differential States of Clusters") +
xlab("Log Fold Change") + ylab("0 - Log Adjusted P-Value")
print(p)
dev.off()
gc()
jpeg(file = paste0(
figureDirectory,
"fprl1",
"fdr",
str_replace_all(str_replace_all(str_replace_all(fileNames, " ", ""), ",", ""), "\\.", "")[1],
markersOrCell,
".jpeg"
))
par(mar = c(1, 1, 1, 1))
p <- ggplot(data =
combinedDf[combinedDf[, "marker_id"] == "FPRL1",],
aes(
x = logFC,
y = minus_log_fdr_adjusted_p_val,
col = fdr_diff_expressed,
label = fdr_label
)) +
geom_point() +
theme_minimal() +
geom_hline(yintercept = -log10(0.05), col = "red") +
geom_hline(yintercept = -log10(0.01), col = "red") +
scale_colour_manual(values = mycolors) +
geom_text_repel() +
ggtitle("Differential States of Clusters") +
xlab("Log Fold Change") + ylab("0 - Log Adjusted P-Value")
print(p)
dev.off()
# bonferroni figures
jpeg(file = paste0(
figureDirectory,
"gpr32",
"bonferroni",
str_replace_all(str_replace_all(str_replace_all(fileNames, " ", ""), ",", ""), "\\.", "")[1],
markersOrCell,
".jpeg"
))
par(mar = c(1, 1, 1, 1))
p <- ggplot(data =
combinedDf[combinedDf[, "marker_id"] == "GPR32",],
aes(
x = logFC,
y = minus_log_bonferroni_adjusted_p_val,
col = bonferroni_diff_expressed,
label = bonferroni_label
)) +
geom_point() +
theme_minimal() +
geom_hline(yintercept = -log10(0.05), col = "red") +
geom_hline(yintercept = -log10(0.01), col = "red") +
scale_colour_manual(values = mycolors) +
geom_text_repel() +
ggtitle("Differential States of Clusters") +
xlab("Log Fold Change") + ylab("0 - Log Adjusted P-Value")
print(p)
dev.off()
gc()
jpeg(file = paste0(
figureDirectory,
"fprl1",
"bonferroni",
str_replace_all(str_replace_all(str_replace_all(fileNames, " ", ""), ",", ""), "\\.", "")[1],
markersOrCell,
".jpeg"
))
par(mar = c(1, 1, 1, 1))
p <- ggplot(data =
combinedDf[combinedDf[, "marker_id"] == "FPRL1",],
aes(
x = logFC,
y = minus_log_bonferroni_adjusted_p_val,
col = bonferroni_diff_expressed,
label = bonferroni_label
)) +
geom_point() +
theme_minimal() +
geom_hline(yintercept = -log10(0.05), col = "red") +
geom_hline(yintercept = -log10(0.01), col = "red") +
scale_colour_manual(values = mycolors) +
geom_text_repel() +
ggtitle("Differential States of Clusters") +
xlab("Log Fold Change") + ylab("0 - Log Adjusted P-Value")
print(p)
dev.off()
gc()
}
